<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°—Ç—É–¥–∏—è –í–æ–ª–æ—Å –í–µ–ª–µ—Å—è | –ö–∞—Ç–∞–ª–æ–≥</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Telegram Web App API -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- –ò–∫–æ–Ω–∫–∏ Lucide -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        /* –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–µ–º–Ω–æ–π —Ç–µ–º—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –ø–æ–∫–∞ Telegram –Ω–µ –∑–∞–≥—Ä—É–∑–∏—Ç —Å–≤–æ—é —Ç–µ–º—É */
        :root {
            /* –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –∞–¥–∞–ø—Ç–∞—Ü–∏–∏ –∫ —Ç–µ–º–µ Telegram */
            --bg-color: var(--tg-theme-bg-color, #17212b); /* –¢–µ–º–Ω—ã–π —Ñ–æ–Ω */
            --secondary-bg-color: var(--tg-theme-secondary-bg-color, #1c2630); /* –ö–∞—Ä—Ç–æ—á–∫–∏ –∏ –±–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å */
            --text-color: var(--tg-theme-text-color, #ffffff); /* –ë–µ–ª—ã–π —Ç–µ–∫—Å—Ç */
            --hint-color: var(--tg-theme-hint-color, #a0a0a0); /* –°–µ—Ä—ã–π —Ç–µ–∫—Å—Ç */
            
            /* –ó–æ–ª–æ—Ç—ã–µ –∞–∫—Ü–µ–Ω—Ç—ã –¥–ª—è –ª—é–∫—Å–æ–≤–æ–≥–æ –≤–∏–¥–∞ */
            --link-color: var(--tg-theme-link-color, #D4AF37); /* Gold/Yellow */
            --button-color: var(--tg-theme-button-color, #D4AF37); /* Gold/Yellow */
            --button-text-color: var(--tg-theme-button-text-color, #1c2630); /* –¢–µ–º–Ω—ã–π —Ç–µ–∫—Å—Ç –Ω–∞ –∑–æ–ª–æ—Ç–æ–π –∫–Ω–æ–ø–∫–µ */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            min-height: 100vh; 
        }

        /* --- –°—Ç–∏–ª–∏ –¥–ª—è –ø–æ–ª–∑—É–Ω–∫–æ–≤ (Slider) --- */
        .range-container {
            position: relative;
            height: 35px;
            margin-bottom: 5px;
        }

        .slider {
            -webkit-appearance: none;
            width: 100%;
            height: 5px;
            background: var(--hint-color);
            border-radius: 5px;
            outline: none;
            position: absolute;
            pointer-events: none;
            opacity: 0.8;
        }
        
        /* –ü—Ä–æ–≥—Ä–µ—Å—Å –º–µ–∂–¥—É –ø–æ–ª–∑—É–Ω–∫–∞–º–∏ */
        .range-progress {
            position: absolute;
            height: 5px;
            background: var(--link-color);
            border-radius: 5px;
            pointer-events: none;
            z-index: 10;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: var(--button-color);
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid var(--secondary-bg-color);
            box-shadow: 0 0 5px rgba(0,0,0,0.5);
            pointer-events: all;
            opacity: 1;
        }
        
        /* --- –°—Ç–∏–ª–∏ –¥–ª—è –º—É–ª—å—Ç–∏—Å–µ–ª–µ–∫—Ç–∞ --- */
        .multi-select {
            width: 100%;
            height: 100px;
            border: 1px solid var(--secondary-bg-color);
            border-radius: 8px;
            padding: 5px;
            outline: none;
            background-color: var(--secondary-bg-color);
            color: var(--text-color);
        }
        .multi-select option {
            background-color: var(--secondary-bg-color);
            color: var(--text-color);
            padding: 4px;
        }
        .multi-select option:checked {
            background-color: var(--link-color);
            color: var(--bg-color); /* –¢–µ–º–Ω—ã–π —Ñ–æ–Ω –Ω–∞ –∑–æ–ª–æ—Ç–æ–º */
        }

        /* --- –°—Ç–∏–ª–∏ –¥–ª—è –∫–∞—Ä—Ç–æ—á–∫–∏ —Ç–æ–≤–∞—Ä–∞ (Product Card) --- */
        .product-card {
            background-color: var(--secondary-bg-color);
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            border-radius: 12px;
            transition: transform 0.2s;
            display: flex;
            flex-direction: column;
            height: 100%;
            cursor: pointer; /* –î–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ */
        }
        
        /* –û–±–æ—Ä–∞—á–∏–≤–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ, —á—Ç–æ–±—ã –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç—å —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–µ –∫–ª–∏–∫–∞ –ø–æ –∫–Ω–æ–ø–∫–∞–º */
        .product-card-info-area {
            cursor: default;
        }

        .product-card-image-wrapper {
            width: 100%;
            height: 160px;
            overflow: hidden;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: white; 
            position: relative;
        }
        
        .product-card-image-wrapper img {
            width: 100%;
            height: 100%;
            object-fit: contain; 
        }
        
        .discount-badge {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: var(--secondary-bg-color); /* –¢–µ–º–Ω—ã–π —Ñ–æ–Ω */
            color: var(--link-color); /* –ó–æ–ª–æ—Ç–æ–π —Ç–µ–∫—Å—Ç */
            border: 1px solid var(--link-color); /* –ó–æ–ª–æ—Ç–∞—è —Ä–∞–º–∫–∞ */
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: bold;
        }

        /* --- –°—Ç–∏–ª–∏ –¥–ª—è —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∑–∞–≥–æ–ª–æ–≤–∫–∞ --- */
        .header-fixed {
            position: sticky;
            top: 0;
            z-index: 50;
            background-color: var(--bg-color);
            padding-bottom: 12px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }
    </style>
</head>
<body>

    <!-- –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –®–∞–ø–∫–∞ -->
    <header class="header-fixed p-4">
        <div class="flex justify-between items-center mb-4">
            <!-- –õ–æ–≥–æ—Ç–∏–ø –∏ –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
            <div class="flex items-center space-x-3">
                <!-- –õ–æ–≥–æ—Ç–∏–ø -->
                <img src="uploaded:image_85bc22.jpg-dc942e2f-20f3-47b9-a250-ecd470bab1ef" 
                     alt="–°—Ç—É–¥–∏—è –í–æ–ª–æ—Å –í–µ–ª–µ—Å—è –õ–æ–≥–æ" 
                     class="w-8 h-8 rounded-full object-cover shadow-lg">
                     
                <h1 class="text-xl font-bold" 
                    style="color: var(--text-color);">–°—Ç—É–¥–∏—è –í–æ–ª–æ—Å –í–µ–ª–µ—Å—è | –ö–∞—Ç–∞–ª–æ–≥</h1>
            </div>
            
            <!-- –ö–æ—Ä–∑–∏–Ω–∞ -->
            <div class="relative cursor-pointer" id="cartIconContainer">
                <i data-lucide="shopping-cart" class="w-6 h-6" style="color: var(--text-color);"></i>
                <span id="cartCountBadge" class="absolute -top-1 -right-1.5 px-1.5 text-xs font-bold rounded-full" 
                      style="background-color: var(--button-color); color: var(--button-text-color); display: none;">
                    0
                </span>
            </div>
        </div>

        <!-- –ü–æ–∏—Å–∫ –∏ –§–∏–ª—å—Ç—Ä—ã -->
        <div class="flex space-x-3">
            <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫ –ø–æ —Ç–æ–≤–∞—Ä–∞–º..."
                   class="flex-grow p-3 rounded-lg border-none focus:ring-2"
                   style="background-color: var(--secondary-bg-color); color: var(--text-color); focus-ring-color: var(--link-color);"
            >
            <button id="toggleFilters" class="p-3 rounded-lg flex items-center justify-center"
                    style="background-color: var(--secondary-bg-color);">
                <i data-lucide="sliders" class="w-6 h-6" style="color: var(--link-color);"></i>
            </button>
        </div>
    </header>

    <div class="p-4 pt-0">
        <!-- –ì—Ä—É–ø–ø–∞ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ —Ç–æ–≤–∞—Ä–æ–≤ -->
        <div class="flex justify-between items-center my-4">
            <h2 class="text-lg font-semibold" style="color: var(--text-color);">–í—Å–µ —Ç–æ–≤–∞—Ä—ã</h2>
            <span id="productCount" class="text-sm" style="color: var(--hint-color);">0 —Ç–æ–≤–∞—Ä–æ–≤</span>
        </div>
        
        <!-- –§–∏–ª—å—Ç—Ä—ã (Sidebar/Modal) -->
        <aside id="filterAside" class="mb-6 hidden">
            <div class="p-4 rounded-xl mb-4" 
                 style="background-color: var(--secondary-bg-color);">
                
                <h3 class="text-xl font-semibold mb-4 border-b pb-2" 
                    style="color: var(--link-color); border-color: var(--secondary-bg-color);">
                    üîç –§–∏–ª—å—Ç—Ä—ã
                </h3>
                
                <!-- –ü–æ–ª–∑—É–Ω–æ–∫ –¥–ª–∏–Ω—ã -->
                <div class="mb-6">
                    <label class="block font-medium mb-2" style="color: var(--text-color);">
                        üìè –î–ª–∏–Ω–∞: <span id="lengthValue" style="color: var(--link-color);">14-30 —Å–º</span>
                    </label>
                    <div class="range-container">
                        <div id="lengthProgress" class="range-progress"></div>
                        <input type="range" id="lengthMin" min="14" max="30" value="14" class="slider z-20">
                        <input type="range" id="lengthMax" min="14" max="30" value="30" class="slider z-30">
                    </div>
                    <div class="flex justify-between mt-1 text-sm" style="color: var(--hint-color);">
                        <span>14 —Å–º</span>
                        <span>30 —Å–º</span>
                    </div>
                </div>
                
                <!-- –ü–æ–ª–∑—É–Ω–æ–∫ —Ü–µ–Ω—ã -->
                <div class="mb-6">
                    <label class="block font-medium mb-2" style="color: var(--text-color);">
                        üí∞ –¶–µ–Ω–∞: <span id="priceValue" style="color: var(--link-color);">1000-10000 ‚ÇΩ</span>
                    </label>
                    <div class="range-container">
                         <div id="priceProgress" class="range-progress"></div>
                        <input type="range" id="priceMin" min="1000" max="10000" value="1000" class="slider z-20">
                        <input type="range" id="priceMax" min="1000" max="10000" value="10000" class="slider z-30">
                    </div>
                    <div class="flex justify-between mt-1 text-sm" style="color: var(--hint-color);">
                        <span>1000 ‚ÇΩ</span>
                        <span>10000 ‚ÇΩ</span>
                    </div>
                </div>
                
                <!-- –§–∏–ª—å—Ç—Ä —Ü–≤–µ—Ç–∞ -->
                <div class="mb-4">
                    <label class="block font-medium mb-2" style="color: var(--text-color);">
                        üé® –¶–≤–µ—Ç:
                    </label>
                    <select id="colorFilter" multiple class="multi-select">
                        <!-- –û–ø—Ü–∏–∏ —Ü–≤–µ—Ç–æ–≤ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã JS -->
                    </select>
                </div>
                
                <!-- –ö–Ω–æ–ø–∫–∏ -->
                <button id="applyFilters" class="w-full py-3 rounded-lg font-semibold transition mt-4"
                        style="background-color: var(--link-color); color: var(--button-text-color);">
                    –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
                </button>
                <button id="resetFilters" class="w-full py-3 rounded-lg font-semibold transition mt-2 border"
                        style="background-color: var(--secondary-bg-color); color: var(--text-color); border-color: var(--hint-color);">
                    –°–±—Ä–æ—Å–∏—Ç—å
                </button>
            </div>
        </aside>

        <!-- –ö–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä–æ–≤ -->
        <main>
            <div id="productsContainer" class="grid grid-cols-2 gap-4">
                <!-- –¢–æ–≤–∞—Ä—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —Å—é–¥–∞ -->
            </div>
        </main>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–µ—Ç–∞–ª–µ–π —Ç–æ–≤–∞—Ä–∞ -->
    <div id="productDetailModal" class="fixed inset-0 z-[100] hidden" 
         style="background-color: rgba(0, 0, 0, 0.8);">
        <div class="absolute inset-0 flex items-center justify-center p-4">
            <div id="productDetailContent" class="w-full max-w-lg p-6 rounded-xl overflow-y-auto max-h-full" 
                 style="background-color: var(--secondary-bg-color); color: var(--text-color);">
                <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω JS -->
            </div>
        </div>
    </div>

    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–∫–æ–Ω–æ–∫ Lucide
        lucide.createIcons();
        
        // --- –ö–ª–∞—Å—Å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–∞—Ç–∞–ª–æ–≥–æ–º (–∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π app.js) ---
        class HairShopCatalog {
            constructor() {
                // –í–ê–® CSV_URL
                this.CSV_URL = "https://docs.google.com/spreadsheets/d/15KZ6DHJD4zin2nATxLG-xBGx-BClYWUDAY_mW0VIwoM/export?format=csv&gid=0";
                
                // –õ–æ–≥–æ—Ç–∏–ø –¥–ª—è –∑–∞–≥–ª—É—à–∫–∏
                this.FALLBACK_IMAGE = 'uploaded:image_85bc22.jpg-dc942e2f-20f3-47b9-a250-ecd470bab1ef';
                
                this.products = [];
                this.filterRanges = null;
                this.filters = {
                    minLength: 14,
                    maxLength: 30,
                    minPrice: 1000,
                    maxPrice: 10000,
                    colors: []
                };
                
                this.cart = new Map(); // –ö–∞—Ä—Ç–∞ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–æ—Ä–∑–∏–Ω—ã: id -> –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
                this.init();
            }

            async init() {
                if (window.Telegram && window.Telegram.WebApp) {
                    window.Telegram.WebApp.ready();
                    this.applyTelegramTheme();
                    
                    // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ MainButton –¥–ª—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞
                    window.Telegram.WebApp.MainButton.setText("–ö –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—é (0 ‚ÇΩ)");
                    window.Telegram.WebApp.MainButton.show();
                    window.Telegram.WebApp.MainButton.onClick(this.viewCart.bind(this));
                    
                    console.log("Telegram WebApp API –≥–æ—Ç–æ–≤. –ê–∫–∫–∞—É–Ω—Ç –æ–ø—Ä–µ–¥–µ–ª–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.");
                } else {
                    console.warn("Telegram WebApp API –Ω–µ –Ω–∞–π–¥–µ–Ω. –†–∞–±–æ—Ç–∞ –≤ —Ä–µ–∂–∏–º–µ –æ–±—ã—á–Ω–æ–≥–æ –±—Ä–∞—É–∑–µ—Ä–∞.");
                }

                this.renderLoading();
                await this.loadProductsFromCSV();
                this.setupEventListeners();
                this.updateMainButton();
            }
            
            /**
             * –ü—Ä–∏–º–µ–Ω—è–µ—Ç —Ü–≤–µ—Ç–∞ Telegram –∫ CSS –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º
             */
            applyTelegramTheme() {
                const params = window.Telegram.WebApp.themeParams;
                if (params) {
                    // –ó–∞–º–µ–Ω—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ –∫–æ—Ä–Ω–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞
                    document.documentElement.style.setProperty('--bg-color', params.bg_color || '#17212b');
                    document.documentElement.style.setProperty('--secondary-bg-color', params.secondary_bg_color || '#1c2630');
                    document.documentElement.style.setProperty('--text-color', params.text_color || '#ffffff');
                    document.documentElement.style.setProperty('--hint-color', params.hint_color || '#a0a0a0');
                    document.documentElement.style.setProperty('--link-color', params.link_color || '#D4AF37');
                    document.documentElement.style.setProperty('--button-color', params.button_color || '#D4AF37');
                    document.documentElement.style.setProperty('--button-text-color', params.button_text_color || '#1c2630');
                }
            }
            
            /**
             * –ó–∞–≥—Ä—É–∑–∫–∞ –∏ –ø–∞—Ä—Å–∏–Ω–≥ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Google –¢–∞–±–ª–∏—Ü—ã –≤ —Ñ–æ—Ä–º–∞—Ç–µ CSV.
             */
            async loadProductsFromCSV() {
                try {
                    console.log('üì• –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑:', this.CSV_URL);
                    const response = await fetch(this.CSV_URL);
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø –∫ CSV.`);
                    }
                    
                    const csvText = await response.text();
                    this.products = this.parseCSV(csvText);
                    
                    if (this.products.length === 0) {
                         this.renderError('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–ª–∏ —Ä–∞–∑–æ–±—Ä–∞—Ç—å —Ç–æ–≤–∞—Ä—ã. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å: —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å, –∑–∞–≥–æ–ª–æ–≤–∫–∏ (RAW) –∏ –ø–µ—Ä–≤—É—é —Å—Ç—Ä–æ–∫—É –¥–∞–Ω–Ω—ã—Ö (RAW).');
                         return;
                    }
                    
                    this.initializeFilters();
                    this.applyFilters();

                } catch (error) {
                    console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∫–∞—Ç–∞–ª–æ–≥–∞:', error);
                    this.renderError(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ${error.message}. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –¥–ª—è –¥–µ—Ç–∞–ª–µ–π.`);
                    if (window.Telegram && window.Telegram.WebApp) {
                        // –ò—Å–ø–æ–ª—å–∑—É–µ–º showAlert, —Ç–∞–∫ –∫–∞–∫ —ç—Ç–æ –±–æ–ª–µ–µ —Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π –º–µ—Ç–æ–¥
                        window.Telegram.WebApp.showAlert(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}`);
                    }
                }
            }

            /**
             * –ü–∞—Ä—Å–∏–Ω–≥ —Å—Ç—Ä–æ–∫–∏ CSV —Å —É—á–µ—Ç–æ–º —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—è.
             */
            parseCSV(csvText) {
                // –ò—â–µ–º –≤–æ–∑–º–æ–∂–Ω—ã–µ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏: , –∏–ª–∏ ;
                const delimiter = csvText.includes(';') ? ';' : ','; 
                const lines = csvText.split(/\r\n|\n|\r/).filter(line => line.trim() !== '');
                if (lines.length < 2) return [];

                const headers = lines[0].split(delimiter).map(h => h.trim().replace(/"/g, '').toLowerCase());
                
                const mapKeyToHeader = {
                    'id': ['id'],
                    'name': ['name', '–Ω–∞–∑–≤–∞–Ω–∏–µ'],
                    'length': ['length', '–¥–ª–∏–Ω–∞'],
                    'color': ['color', '—Ü–≤–µ—Ç'],
                    'price': ['price', '—Ü–µ–Ω–∞'],
                    'oldPrice': ['old_price', '—Å—Ç–∞—Ä–∞—è_—Ü–µ–Ω–∞', 'oldprice'],
                    'imageUrl': ['images', '–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ', '—Ñ–æ—Ç–æ', 'imageurl']
                };

                const columnIndices = {};
                Object.keys(mapKeyToHeader).forEach(key => {
                    const aliases = mapKeyToHeader[key];
                    const index = headers.findIndex(h => aliases.some(alias => h.includes(alias)));
                    columnIndices[key] = index;
                });

                const products = [];

                for (let i = 1; i < lines.length; i++) {
                    const values = this.parseCSVLine(lines[i], delimiter);
                    const product = {};
                    
                    const getValue = (index) => (index !== -1 && values[index] !== undefined) ? values[index].trim() : '';
                    
                    product.id = parseInt(getValue(columnIndices.id).replace(/[^\d]/g, ''), 10) || i; // Fallback ID
                    product.price = parseInt(getValue(columnIndices.price).replace(/[^\d]/g, ''), 10) || 0;
                    product.length = parseInt(getValue(columnIndices.length).replace(/[^\d]/g, ''), 10) || 0;
                    product.oldPrice = parseInt(getValue(columnIndices.oldPrice).replace(/[^\d]/g, ''), 10) || 0;
                    
                    product.name = getValue(columnIndices.name);
                    product.color = getValue(columnIndices.color);
                    product.imageUrl = getValue(columnIndices.imageUrl);

                    if (product.id && product.price > 0 && product.length > 0) {
                        products.push(product);
                    }
                }
                return products;
            }

            /**
             * –ë–æ–ª–µ–µ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –ø–∞—Ä—Å–µ—Ä —Å—Ç—Ä–æ–∫–∏ —Å —É—á–µ—Ç–æ–º —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—è –∏ –∫–∞–≤—ã—á–µ–∫.
             */
            parseCSVLine(line, delimiter) {
                 const regex = new RegExp(`(?:"[^"]*"|[^"${delimiter}]*)${delimiter}`, 'g');
                 const values = [];
                 let match;

                 while ((match = regex.exec(line)) !== null) {
                     let field = match[0].substring(0, match[0].length - delimiter.length).trim();
                     if (field.startsWith('"') && field.endsWith('"')) {
                         field = field.substring(1, field.length - 1).replace(/""/g, '"');
                     }
                     values.push(field);
                 }
                 
                 const lastMatch = line.substring(regex.lastIndex).trim();
                 let finalField = lastMatch;
                 if (finalField.startsWith('"') && finalField.endsWith('"')) {
                     finalField = finalField.substring(1, finalField.length - 1).replace(/""/g, '"');
                 }
                 values.push(finalField);
                 
                 return values;
            }

            initializeFilters() {
                if (this.products.length === 0) return;

                const allLengths = this.products.map(p => p.length).filter(l => l > 0);
                const allPrices = this.products.map(p => p.price).filter(p => p > 0);

                if (allLengths.length === 0 || allPrices.length === 0) return;

                const minLength = Math.min(...allLengths);
                const maxLength = Math.max(...allLengths);
                const minPrice = Math.min(...allPrices);
                const maxPrice = Math.max(...allPrices);

                this.filterRanges = {
                    length: { min: minLength, max: maxLength },
                    price: { min: minPrice, max: maxPrice }
                };

                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –≤ –Ω–∞–π–¥–µ–Ω–Ω—ã–µ –¥–∏–∞–ø–∞–∑–æ–Ω—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                this.filters = {
                    minLength: minLength,
                    maxLength: maxLength,
                    minPrice: minPrice,
                    maxPrice: maxPrice,
                    colors: []
                };
                
                this.updateRangeSliders();
                this.updateRangeLabels();
                this.updateColorOptions();
            }

            updateColorOptions() {
                const colorSelect = document.getElementById('colorFilter');
                if (!colorSelect) return;

                const uniqueColors = new Set(this.products
                    .map(p => p.color)
                    .filter(c => c && c.trim() !== '')
                    .sort()
                );

                colorSelect.innerHTML = '';

                uniqueColors.forEach(color => {
                    const option = document.createElement('option');
                    option.value = color;
                    option.textContent = color;
                    colorSelect.appendChild(option);
                });
            }

            updateRangeSliders() {
                if (!this.filterRanges) return;
                
                const { length, price } = this.filterRanges;

                const updateSlider = (id, min, max, value) => {
                    const input = document.getElementById(id);
                    if (input) {
                         input.min = min;
                         input.max = max;
                         input.value = value;
                    }
                };

                updateSlider('lengthMin', length.min, length.max, this.filters.minLength);
                updateSlider('lengthMax', length.min, length.max, this.filters.maxLength);
                updateSlider('priceMin', price.min, price.max, this.filters.minPrice);
                updateSlider('priceMax', price.min, price.max, this.filters.maxPrice);
                
                this.updateRangeProgress();
            }
            
            updateRangeLabels() {
                const lengthValueSpan = document.getElementById('lengthValue');
                if (lengthValueSpan) {
                    lengthValueSpan.textContent = `${this.filters.minLength}-${this.filters.maxLength} —Å–º`;
                }
                
                const priceValueSpan = document.getElementById('priceValue');
                if (priceValueSpan) {
                    priceValueSpan.textContent = `${this.filters.minPrice.toLocaleString()}‚Äì${this.filters.maxPrice.toLocaleString()} ‚ÇΩ`;
                }
            }
            
            updateRangeProgress() {
                ['length', 'price'].forEach(type => {
                    const progress = document.getElementById(`${type}Progress`);
                    const minInput = document.getElementById(`${type}Min`);
                    const maxInput = document.getElementById(`${type}Max`);
                    const range = this.filterRanges?.[type];
                    
                    if (progress && minInput && maxInput && range) {
                        const minVal = parseInt(minInput.value);
                        const maxVal = parseInt(maxInput.value);
                        
                        const rangeSize = range.max - range.min;
                        
                        if (rangeSize === 0) {
                            progress.style.left = '0%';
                            progress.style.right = '0%';
                            return;
                        }

                        const leftPercent = ((minVal - range.min) / rangeSize) * 100;
                        const rightPercent = 100 - ((maxVal - range.min) / rangeSize) * 100;
                        
                        progress.style.left = `${leftPercent}%`;
                        progress.style.right = `${rightPercent}%`;
                    }
                });
            }


            renderProducts(products) {
                const container = document.getElementById('productsContainer');
                const countSpan = document.getElementById('productCount');
                if (!container || !countSpan) return;

                if (products.length === 0) {
                    container.innerHTML = `<p class="col-span-2 text-center p-8 text-lg" style="color: var(--hint-color);">–ü–æ –≤–∞—à–∏–º —Ñ–∏–ª—å—Ç—Ä–∞–º –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.</p>`;
                    countSpan.textContent = `0 —Ç–æ–≤–∞—Ä–æ–≤`;
                    return;
                }

                container.innerHTML = products.map(product => this.createProductCard(product)).join('');
                countSpan.textContent = `${products.length} —Ç–æ–≤–∞—Ä–æ–≤`;

                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–∫–æ–Ω–æ–∫
                lucide.createIcons();
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –ø–æ—Å–ª–µ —Ä–µ–Ω–¥–µ—Ä–∞
                container.querySelectorAll('.add-to-cart').forEach(button => {
                    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–ø–ª—ã—Ç–∏–µ, —á—Ç–æ–±—ã –∫–ª–∏–∫ –Ω–µ –æ—Ç–∫—Ä—ã–≤–∞–ª –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–µ—Ç–∞–ª–µ–π
                    button.addEventListener('click', (e) => {
                        e.stopPropagation(); 
                        const productId = parseInt(e.currentTarget.dataset.id);
                        this.addToCart(productId);
                    });
                });
                
                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –¥–µ—Ç–∞–ª–µ–π
                container.querySelectorAll('.product-card').forEach(card => {
                    const productId = parseInt(card.dataset.id);
                    if (!card.hasAttribute('onclick')) {
                        card.addEventListener('click', () => this.showProductDetails(productId));
                    }
                });
            }

            /**
             * –°–æ–∑–¥–∞–µ—Ç HTML-—Ä–∞–∑–º–µ—Ç–∫—É –¥–ª—è –æ–¥–Ω–æ–π –∫–∞—Ä—Ç–æ—á–∫–∏ —Ç–æ–≤–∞—Ä–∞ –≤ —Å—Ç–∏–ª–µ Mini App.
             */
            createProductCard(product) {
                const hasDiscount = product.oldPrice > 0 && product.oldPrice > product.price;
                const inCart = this.cart.has(product.id);
                const currentQuantity = this.cart.get(product.id) || 0;
                
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º mock-–±–æ–Ω—É—Å—ã, —Ç.–∫. –∏—Ö –Ω–µ—Ç –≤ CSV
                const bonuses = product.price > 5000 ? 200 : 0; 
                
                const name = product.name || '–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–µ —É–∫–∞–∑–∞–Ω–æ';
                const price = product.price || 0;
                const oldPrice = product.oldPrice || 0;
                
                // –î–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É–µ–º URL-–ø—Ä–µ—Ñ–∏–∫—Å, —Ç–∞–∫ –∫–∞–∫ –≤ CSV —Ç–æ–ª—å–∫–æ –∏–º—è —Ñ–∞–π–ª–∞
                const imageBaseUrl = "https://example.com/images/"; 
                const imageUrl = product.imageUrl ? `${imageBaseUrl}${product.imageUrl}` : this.FALLBACK_IMAGE;
                
                return `
                    <div class="product-card" data-id="${product.id}" onclick="catalog.showProductDetails(${product.id})">
                        
                        <!-- –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏ —à–∏–ª—å–¥–∏–∫–∏ -->
                        <div class="product-card-image-wrapper">
                            <img src="${imageUrl}" 
                                 alt="${name}" 
                                 onerror="this.onerror=null; this.src='${this.FALLBACK_IMAGE}';"
                                 loading="lazy">
                             ${bonuses > 0 ? 
                                `<span class="discount-badge" 
                                    style="background-color: var(--secondary-bg-color); color: var(--link-color); border: 1px solid var(--link-color);">
                                    +${bonuses} –±–æ–Ω—É—Å–æ–≤
                                </span>` : ''}
                            <i data-lucide="heart" class="w-6 h-6 absolute top-3 right-3" 
                               style="color: var(--text-color); cursor: pointer; background: rgba(28, 38, 48, 0.7); border-radius: 9999px; padding: 4px;"></i>
                        </div>
                        
                        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
                        <div class="p-3 product-card-info-area">
                            <div class="flex items-baseline justify-start mb-1">
                                <span class="text-xl font-bold" 
                                      style="color: var(--text-color);">
                                    ${price.toLocaleString()} ‚ÇΩ
                                </span>
                                ${hasDiscount && oldPrice > price ? 
                                    `<span class="ml-2 text-sm line-through" style="color: var(--hint-color);">
                                        ${oldPrice.toLocaleString()} ‚ÇΩ
                                    </span>` : ''
                                }
                            </div>
                            
                            <h3 class="text-sm font-normal mb-3 leading-tight" style="min-height: 38px; color: var(--text-color);">
                                ${name}
                            </h3>

                            <!-- –ö–Ω–æ–ø–∫–∞/–°—á–µ—Ç—á–∏–∫ -->
                            <div class="flex">
                                ${inCart ? 
                                    `
                                    <div class="flex items-center w-full justify-between" 
                                         style="background-color: var(--link-color); color: var(--button-text-color); border-radius: 8px;">
                                        <button class="w-10 h-10 flex items-center justify-center text-xl font-bold" 
                                                onclick="catalog.updateQuantity(${product.id}, -1); event.stopPropagation();">
                                            ‚Äì
                                        </button>
                                        <span class="font-bold">${currentQuantity}</span>
                                        <button class="w-10 h-10 flex items-center justify-center text-xl font-bold" 
                                                onclick="catalog.updateQuantity(${product.id}, 1); event.stopPropagation();">
                                            +
                                        </button>
                                    </div>
                                    ` : 
                                    `
                                    <button class="add-to-cart w-full py-2 rounded-lg font-semibold transition" 
                                            data-id="${product.id}"
                                            style="background-color: var(--link-color); color: var(--button-text-color);">
                                        –í –∫–æ—Ä–∑–∏–Ω—É
                                    </button>
                                    `
                                }
                            </div>
                        </div>
                    </div>
                `;
            }

            renderLoading() {
                const container = document.getElementById('productsContainer');
                if (container) {
                    container.innerHTML = `<p class="col-span-2 text-center p-8 text-lg" style="color: var(--hint-color);">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ç–∞–ª–æ–≥–∞... ‚è≥</p>`;
                }
            }
            
            renderError(message) {
                const container = document.getElementById('productsContainer');
                if (container) {
                    container.innerHTML = `<div class="col-span-2 p-4 rounded-lg font-semibold" style="background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb;">${message}</div>`;
                }
            }


            setupEventListeners() {
                // –ü–æ–ª–∑—É–Ω–∫–∏
                ['length', 'price'].forEach(type => {
                    const minInput = document.getElementById(`${type}Min`);
                    const maxInput = document.getElementById(`${type}Max`);
                    
                    if (minInput) minInput.addEventListener('input', (e) => this.handleRangeInput(type, 'min', parseInt(e.target.value)));
                    if (maxInput) maxInput.addEventListener('input', (e) => this.handleRangeInput(type, 'max', parseInt(e.target.value)));
                });
                
                // –ú—É–ª—å—Ç–∏—Å–µ–ª–µ–∫—Ç –ø–æ —Ü–≤–µ—Ç—É
                const colorFilter = document.getElementById('colorFilter');
                    colorFilter.addEventListener('change', () => {
                        this.updateColorFilters();
                        this.applyFilters();
                    });
                
                // –ö–Ω–æ–ø–∫–∏
                document.getElementById('applyFilters')?.addEventListener('click', () => this.applyFilters());
                document.getElementById('resetFilters')?.addEventListener('click', () => this.resetFilters());
                document.getElementById('toggleFilters')?.addEventListener('click', () => this.toggleFiltersVisibility());
                document.getElementById('searchInput')?.addEventListener('input', () => this.applyFilters()); // –ü–æ–∏—Å–∫
                
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∏–∫–æ–Ω–∫–∏ –∫–æ—Ä–∑–∏–Ω—ã –≤ —à–∞–ø–∫–µ
                document.getElementById('cartIconContainer')?.addEventListener('click', () => this.viewCart());
            }
            
            toggleFiltersVisibility() {
                const aside = document.getElementById('filterAside');
                if (aside) {
                    aside.classList.toggle('hidden');
                    if (window.Telegram && window.Telegram.WebApp) {
                        window.Telegram.WebApp.expand();
                    }
                }
            }

            handleRangeInput(type, boundary, value) {
                // –õ–æ–≥–∏–∫–∞ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –∏–Ω–≤–µ—Ä—Å–∏–∏
                if (type === 'length') {
                    if (boundary === 'min' && value > this.filters.maxLength) value = this.filters.maxLength;
                    if (boundary === 'max' && value < this.filters.minLength) value = this.filters.minLength;
                    this.filters[boundary === 'min' ? 'minLength' : 'maxLength'] = value;
                } else if (type === 'price') {
                    if (boundary === 'min' && value > this.filters.maxPrice) value = this.filters.maxPrice;
                    if (boundary === 'max' && value < this.filters.minPrice) value = this.filters.minPrice;
                    this.filters[boundary === 'min' ? 'minPrice' : 'maxPrice'] = value;
                }
                
                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ª–∑—É–Ω–∫–∞ –∏ –º–µ—Ç–æ–∫
                const inputId = `${type}${boundary === 'min' ? 'Min' : 'Max'}`;
                document.getElementById(inputId).value = value;
                
                this.updateRangeLabels();
                this.updateRangeProgress();
                this.applyFilters();
            }
            
            updateColorFilters() {
                const selectElement = document.getElementById('colorFilter');
                if (!selectElement) return;

                this.filters.colors = Array.from(selectElement.selectedOptions).map(option => option.value.trim());
            }

            applyFilters() {
                const searchText = document.getElementById('searchInput')?.value.toLowerCase() || '';
                
                const filteredProducts = this.products.filter(product => {
                    // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –¥–∏–∞–ø–∞–∑–æ–Ω–∞–º
                    const lengthMatch = product.length >= this.filters.minLength && product.length <= this.filters.maxLength;
                    const priceMatch = product.price >= this.filters.minPrice && product.price <= this.filters.maxPrice;
                    
                    // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —Ü–≤–µ—Ç—É
                    const colorMatch = this.filters.colors.length === 0 || this.filters.colors.includes(product.color);
                    
                    // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –ø–æ–∏—Å–∫—É (–∏–º—è, —Ü–≤–µ—Ç)
                    const searchMatch = (product.name?.toLowerCase() || '').includes(searchText) || 
                                        (product.color?.toLowerCase() || '').includes(searchText);
                    
                    return lengthMatch && priceMatch && colorMatch && searchMatch;
                });
                
                this.renderProducts(filteredProducts);
            }

            resetFilters() {
                if (this.filterRanges) {
                    this.filters = {
                        minLength: this.filterRanges.length.min,
                        maxLength: this.filterRanges.length.max,
                        minPrice: this.filterRanges.price.min,
                        maxPrice: this.filterRanges.price.max,
                        colors: []
                    };
                    
                    const searchInput = document.getElementById('searchInput');
                    if (searchInput) searchInput.value = '';

                    const colorSelect = document.getElementById('colorFilter');
                    if (colorSelect) {
                        Array.from(colorSelect.options).forEach(option => option.selected = false);
                    }
                    
                    this.updateRangeSliders();
                    this.updateRangeLabels();
                    this.applyFilters();
                }
            }

            addToCart(productId) {
                this.updateQuantity(productId, 1);
            }

            updateQuantity(productId, delta) {
                const current = this.cart.get(productId) || 0;
                const newQuantity = current + delta;
                
                if (newQuantity <= 0) {
                    this.cart.delete(productId);
                } else {
                    this.cart.set(productId, newQuantity);
                }
                
                // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å —Ç–æ–≤–∞—Ä–∞–º–∏
                this.applyFilters(); 
                this.updateMainButton();
            }

            updateMainButton() {
                const totalItems = Array.from(this.cart.values()).reduce((sum, count) => sum + count, 0);
                const totalPrice = this.cartTotal;
                
                const badge = document.getElementById('cartCountBadge');
                if (badge) {
                    if (totalItems > 0) {
                        badge.textContent = totalItems;
                        badge.style.display = 'inline-block';
                    } else {
                        badge.style.display = 'none';
                    }
                }
                
                if (window.Telegram && window.Telegram.WebApp) {
                    if (totalItems > 0) {
                        // –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏
                        window.Telegram.WebApp.MainButton.setText(`–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑ (${totalPrice.toLocaleString()} ‚ÇΩ)`);
                        window.Telegram.WebApp.MainButton.show();
                    } else {
                        window.Telegram.WebApp.MainButton.hide();
                    }
                }
            }

            viewCart() {
                const totalItems = Array.from(this.cart.values()).reduce((sum, count) => sum + count, 0);
                
                if (totalItems === 0) {
                    if (window.Telegram && window.Telegram.WebApp) {
                        window.Telegram.WebApp.showAlert('–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞. –î–æ–±–∞–≤—å—Ç–µ —Ç–æ–≤–∞—Ä—ã.');
                    }
                    return;
                }

                // –°–æ–∑–¥–∞–µ–º —Å–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ JSON
                const cartItemsList = [];
                this.cart.forEach((count, id) => {
                    const product = this.products.find(p => p.id === id);
                    if (product) {
                        cartItemsList.push({
                            id: product.id,
                            name: product.name,
                            price: product.price,
                            quantity: count
                        });
                    }
                });

                const cartData = {
                    action: 'checkout_request',
                    totalPrice: this.cartTotal,
                    items: cartItemsList,
                    // –î–æ–±–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è
                    user: window.Telegram.WebApp.initDataUnsafe.user || { id: 'anonymous' }
                };
                
                const jsonPayload = JSON.stringify(cartData, null, 2);
                
                const message = `
                    –í—ã –¥–æ–±–∞–≤–∏–ª–∏ ${totalItems} —à—Ç. –Ω–∞ —Å—É–º–º—É ${this.cartTotal.toLocaleString()} ‚ÇΩ.
                    \n\n--- –°–æ—Å—Ç–∞–≤ –∑–∞–∫–∞–∑–∞ ---\n
                    ${cartItemsList.map(item => `${item.name} (${item.quantity} —à—Ç.) - ${item.price * item.quantity} ‚ÇΩ`).join('\n')}
                    \n\n–ù–∞–∂–º–∏—Ç–µ "–û–ö", —á—Ç–æ–±—ã –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑ –≤ —á–∞—Ç —Å –±–æ—Ç–æ–º.
                `;


                 if (window.Telegram && window.Telegram.WebApp) {
                    // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ showAlert –≤–º–µ—Å—Ç–æ showPopup –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å –≤–µ—Ä—Å–∏–µ–π 6.0
                    window.Telegram.WebApp.showAlert(message, () => {
                         // –ü–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è (–Ω–∞–∂–∞—Ç–∏—è –û–ö –≤ showAlert)
                         window.Telegram.WebApp.sendData(jsonPayload);
                         window.Telegram.WebApp.close(); // –ó–∞–∫—Ä—ã–≤–∞–µ–º Mini App
                    });
                 }
            }
            
            get cartTotal() {
                let total = 0;
                this.cart.forEach((count, id) => {
                    const product = this.products.find(p => p.id === id);
                    if (product) {
                        total += (product.price || 0) * count;
                    }
                });
                return total;
            }
            
            showProductDetails(productId) {
                const product = this.products.find(p => p.id === productId);
                const modal = document.getElementById('productDetailModal');
                const content = document.getElementById('productDetailContent');

                if (!product || !modal || !content) return;
                
                const hasDiscount = product.oldPrice > 0 && product.oldPrice > product.price;

                // –î–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É–µ–º URL-–ø—Ä–µ—Ñ–∏–∫—Å –∏–ª–∏ –∑–∞–≥–ª—É—à–∫—É
                const imageBaseUrl = "https://example.com/images/";
                const imageUrl = product.imageUrl ? `${imageBaseUrl}${product.imageUrl}` : this.FALLBACK_IMAGE;
                
                const inCart = this.cart.has(product.id);
                const currentQuantity = this.cart.get(product.id) || 0;

                content.innerHTML = `
                    <div class="flex justify-end">
                        <button onclick="catalog.hideProductDetails()" class="p-2 -mt-3 -mr-3 rounded-full hover:opacity-75 transition" style="color: var(--text-color);">
                            <i data-lucide="x" class="w-6 h-6"></i>
                        </button>
                    </div>
                    
                    <div class="text-center mb-4">
                        <div class="w-full h-48 mx-auto mb-4 rounded-lg overflow-hidden flex items-center justify-center shadow-lg" style="background-color: white;">
                             <img src="${imageUrl}" 
                                  alt="${product.name}" 
                                  class="h-full object-contain" 
                                  onerror="this.onerror=null; this.src='${this.FALLBACK_IMAGE}';">
                        </div>
                        <h2 class="text-2xl font-bold mb-2" style="color: var(--link-color);">${product.name}</h2>
                    </div>

                    <div class="flex justify-center items-baseline mb-4">
                        <span class="text-3xl font-extrabold mr-3">${product.price.toLocaleString()} ‚ÇΩ</span>
                        ${hasDiscount ? 
                            `<span class="text-lg line-through" style="color: var(--hint-color);">${product.oldPrice.toLocaleString()} ‚ÇΩ</span>` : ''
                        }
                    </div>

                    <!-- –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ -->
                    <div class="p-4 rounded-lg mb-6" style="background-color: var(--bg-color);">
                        <p class="font-semibold mb-3 border-b pb-2" style="color: var(--text-color); border-color: var(--secondary-bg-color);">–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –∏ –û–ø–∏—Å–∞–Ω–∏–µ:</p>
                        <ul class="space-y-2 text-sm" style="color: var(--hint-color);">
                            <li><span class="font-medium" style="color: var(--link-color);">üìè –î–ª–∏–Ω–∞:</span> ${product.length} —Å–º</li>
                            <li><span class="font-medium" style="color: var(--link-color);">üé® –¶–≤–µ—Ç:</span> ${product.color}</li>
                            <li><span class="font-medium" style="color: var(--link-color);">–û–ø–∏—Å–∞–Ω–∏–µ:</span> –ö–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —Å–ª–∞–≤—è–Ω—Å–∫–∏–µ –≤–æ–ª–æ—Å—ã, –∏–¥–µ–∞–ª—å–Ω–æ –ø–æ–¥—Ö–æ–¥—è—Ç –¥–ª—è –Ω–∞—Ä–∞—â–∏–≤–∞–Ω–∏—è. –≠–ª–∏—Ç–Ω–∞—è —Å–µ—Ä–∏—è.</li>
                        </ul>
                    </div>

                    <!-- –ö–Ω–æ–ø–∫–∞ "–í –∫–æ—Ä–∑–∏–Ω—É" / –°—á–µ—Ç—á–∏–∫ -->
                    <div class="flex">
                        ${inCart ? 
                            `
                            <div class="flex items-center w-full justify-between p-1 rounded-lg" 
                                 style="background-color: var(--link-color); color: var(--button-text-color);">
                                <button class="w-10 h-10 flex items-center justify-center text-xl font-bold rounded-l-lg hover:opacity-80 transition" 
                                        onclick="catalog.updateQuantity(${product.id}, -1)">
                                    ‚Äì
                                </button>
                                <span class="font-bold">${currentQuantity} –≤ –∫–æ—Ä–∑–∏–Ω–µ</span>
                                <button class="w-10 h-10 flex items-center justify-center text-xl font-bold rounded-r-lg hover:opacity-80 transition" 
                                        onclick="catalog.updateQuantity(${product.id}, 1)">
                                    +
                                </button>
                            </div>
                            ` : 
                            `
                            <button class="w-full py-3 rounded-lg font-semibold transition hover:opacity-90" 
                                    onclick="catalog.addToCart(${product.id});"
                                    style="background-color: var(--link-color); color: var(--button-text-color);">
                                –î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É
                            </button>
                            `
                        }
                    </div>
                    <button class="w-full py-2 rounded-lg font-semibold transition mt-2 text-sm" 
                            onclick="catalog.viewCart(); catalog.hideProductDetails();"
                            style="color: var(--link-color);">
                        –ü–µ—Ä–µ–π—Ç–∏ –∫ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—é
                    </button>
                `;
                lucide.createIcons();
                modal.classList.remove('hidden');
                if (window.Telegram && window.Telegram.WebApp) {
                    window.Telegram.WebApp.expand();
                }
            }

            hideProductDetails() {
                document.getElementById('productDetailModal')?.classList.add('hidden');
            }
        }

        // –ó–∞–ø—É—Å–∫–∞–µ–º –∫–∞—Ç–∞–ª–æ–≥ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ DOM
        document.addEventListener('DOMContentLoaded', function() {
            window.catalog = new HairShopCatalog();
        });
    </script>
</body>
</html>